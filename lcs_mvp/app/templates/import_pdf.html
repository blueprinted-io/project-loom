{% extends "base.html" %}
{% block content %}
<h1>Import Tasks from PDF (AI-assisted)</h1>

{% if error %}
<div class="callout danger">
  <b>Import failed:</b> {{ error }}
</div>
{% endif %}

<div class="callout warn">
  <b>Trust boundary:</b> Imported Tasks are always created as <b>draft</b> and flagged for review. Nothing is auto-confirmed.
</div>

<div class="card">
  <div class="row">
    <div style="flex:1">
      <label style="margin-top:0">LM Studio base URL (browser-local)</label>
      <input id="lmstudio-base-url" value="{{ lmstudio_base_url }}" placeholder="http://127.0.0.1:1234" />
      <div class="muted" style="margin-top:6px">Model: <code>{{ lmstudio_model }}</code></div>
      <div class="muted">Override via env vars: <code>LCS_LMSTUDIO_BASE_URL</code>, <code>LCS_LMSTUDIO_MODEL</code></div>
      <div class="muted" style="margin-top:6px">Post-MVP: store this server-side per user.</div>
    </div>
    <div>
      {% if lmstudio_ok %}
        <span class="badge badge-confirmed" id="lmstudio-pill">LM Studio: reachable</span>
      {% else %}
        <span class="badge badge-warn" id="lmstudio-pill">LM Studio: not reachable</span>
      {% endif %}
      <div class="muted" style="margin-top:6px" id="lmstudio-detail">{{ lmstudio_detail }}</div>
      <button class="btn" type="button" style="margin-top:8px" onclick="recheckLmStudio()">Recheck</button>
    </div>
  </div>
</div>

<script>
function getLmStudioBaseUrl(){
  const el = document.getElementById('lmstudio-base-url');
  return (el && el.value ? el.value : '').trim();
}
function persistLmStudioBaseUrl(){
  try{ localStorage.setItem('lmstudio_base_url', getLmStudioBaseUrl()); }catch(e){}
}
function loadLmStudioBaseUrl(){
  try{
    const saved = localStorage.getItem('lmstudio_base_url');
    const el = document.getElementById('lmstudio-base-url');
    if(el && saved){ el.value = saved; }
  }catch(e){}
}
async function recheckLmStudio(){
  const pill = document.getElementById('lmstudio-pill');
  const detail = document.getElementById('lmstudio-detail');
  const baseUrl = encodeURIComponent(getLmStudioBaseUrl());
  persistLmStudioBaseUrl();
  try{
    const r = await fetch('/_lmstudio/status?base_url=' + baseUrl, {headers:{'Accept':'application/json'}});
    const d = await r.json();
    if(d.ok){
      pill.className = 'badge badge-confirmed';
      pill.textContent = 'LM Studio: reachable';
    } else {
      pill.className = 'badge badge-warn';
      pill.textContent = 'LM Studio: not reachable';
    }
    detail.textContent = d.detail || '';
  } catch(e){
    pill.className = 'badge badge-warn';
    pill.textContent = 'LM Studio: not reachable';
    if(detail) detail.textContent = String(e);
  }
}

loadLmStudioBaseUrl();
</script>

{% if ingestions %}
<div class="card">
  <h2 style="margin-top:0">Previous ingestions</h2>
  <p class="muted">Resume from where you left off. Progress is keyed by document hash, not filename.</p>
  <table class="table">
    <thead><tr><th>File</th><th>Created</th><th>Status</th><th>Cursor</th><th></th></tr></thead>
    <tbody>
      {% for i in ingestions %}
      <tr>
        <td>{{ i.filename }}</td>
        <td class="muted">{{ i.created_at }}</td>
        <td><span class="badge">{{ i.status }}</span></td>
        <td class="muted">chunk {{ i.cursor_chunk }}</td>
        <td><a class="btn" href="/import/pdf/run?ingestion_id={{ i.id }}">Resume</a></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endif %}

<form method="post" action="/import/pdf/prepare" enctype="multipart/form-data" class="card" onsubmit="persistLmStudioBaseUrl(); document.getElementById('lmstudio-base-url-hidden').value=getLmStudioBaseUrl();">
  <input type="hidden" name="lmstudio_base_url" id="lmstudio-base-url-hidden" value="" />

  <label>PDF file</label>
  <input type="file" name="pdf" accept="application/pdf" required />

  <label>Max tasks to propose (per run)</label>
  <input type="number" name="max_tasks" value="10" min="1" max="10" />

  <label>Max chunks to process (per run)</label>
  <input type="number" name="max_chunks" value="8" min="1" max="20" />

  <label>Import note</label>
  <input name="actor_note" value="Imported from PDF" />

  <button class="btn" type="submit">Generate candidates</button>
</form>

<p class="muted">MVP notes: author/admin only. Import creates a candidate list first; nothing is written until you select items.</p>
{% endblock %}
