{% extends "base.html" %}
{% block content %}
<h1>{% if mode=='new' %}New Assessment{% else %}Revise from Assessment v{{ item.version }} (creates new version){% endif %}</h1>
<div class="callout warn" style="margin-top:10px">
  <b>Under construction</b>
  <div class="muted" style="margin-top:6px">This assessment module is in active development. Use for experimentation; expect UX changes.</div>
</div>

{% if lint %}
  {% set lint_errors = lint|selectattr('level','equalto','error')|list %}
  {% set lint_warns = lint|selectattr('level','equalto','warn')|list %}
  <details class="card" style="padding:12px;margin-top:10px" {% if lint_errors|length > 0 %}open{% endif %}>
    <summary style="cursor:pointer">
      <b>Quality checks</b>
      <span class="muted">·</span>
      <span class="badge">{{ lint_errors|length }} errors</span>
      <span class="badge">{{ lint_warns|length }} warnings</span>
      <span class="muted">(errors block submission)</span>
    </summary>
    <div style="margin-top:10px">
      {% if lint_errors %}
        <div class="callout bad"><b>Errors</b></div>
        <ul>
          {% for f in lint_errors %}
            <li><code>{{ f.code }}</code> — {{ f.msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
      {% if lint_warns %}
        <div class="callout warn"><b>Warnings</b></div>
        <ul>
          {% for f in lint_warns %}
            <li><code>{{ f.code }}</code> — {{ f.msg }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    </div>
  </details>
{% endif %}

<form method="post" action="{% if mode=='new' %}/assessments/new{% else %}/assessments/{{ item.record_id }}/{{ item.version }}/save{% endif %}">

  <div class="card" style="padding:12px">
    <h2 style="margin-top:0">1) Draft the item</h2>
    <div class="muted">Write the question first. Classification is optional.</div>
  </div>

  <details class="card" style="padding:12px;margin-top:12px">
    <summary style="cursor:pointer"><b>Advanced (optional)</b> <span class="muted">· anchor helpers</span></summary>
    <div style="margin-top:10px" class="muted">Optional authoring notes. Safe to ignore.</div>

    <div id="helpers-fact" style="display:none">
      <label>Target fact (optional, for you)</label>
      <input name="target_fact" value="" placeholder="e.g. exact limit / definition you want to test" />
    </div>

    <div id="helpers-concept" style="display:none">
      <label>Relation verb (optional)</label>
      <select name="relation_verb">
        <option value="">(none)</option>
        <option value="implies">implies</option>
        <option value="contradicts">contradicts</option>
        <option value="explains">explains</option>
        <option value="distinguishes">distinguishes</option>
      </select>
    </div>

    <div id="helpers-scenario" style="display:none">
      <label>Truth test (optional)</label>
      <select name="scenario_truth">
        <option value="">(none)</option>
        <option value="true">Which is true?</option>
        <option value="not_true">Which is NOT true?</option>
        <option value="cannot_determine">Which cannot be determined from the scenario?</option>
      </select>
    </div>
  </details>

  <div class="card" style="padding:12px;margin-top:12px">
    <h2 style="margin-top:0">3) Write the item</h2>

    <div class="card" style="padding:10px;margin-top:8px">
      <b>Stem template</b>
      <div class="muted" style="margin-top:6px">Insert a scaffold to reduce author load. Edit freely after.</div>
      <div class="row" style="margin-top:8px">
        <button class="btn secondary" type="button" id="tpl-fact">Fact</button>
        <button class="btn secondary" type="button" id="tpl-concept">Concept</button>
        <button class="btn secondary" type="button" id="tpl-scenario">Procedure</button>
      </div>
    </div>

    <label>Stem</label>
    <textarea name="stem" id="stem" rows="5" required>{{ item.stem if item else '' }}</textarea>

    <div class="row" style="margin-top:12px;align-items:flex-end">
      <div style="flex:1">
        <label>Probe type (optional)</label>
        {% set cur = (item.claim if item else 'auto') %}
        <select name="claim" id="claim">
          {% for c in ['auto','fact_probe','concept_probe','procedure_proxy'] %}
            <option value="{{ c }}" {% if cur==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <div class="muted" style="margin-top:6px">Used for peek + review. Safe to leave on <code>auto</code>.</div>
      </div>
      <div style="width:180px">
        <label>&nbsp;</label>
        <button class="btn secondary" type="button" id="peek-source">Peek source</button>
      </div>
    </div>
  </div>

  <label>Options</label>
  <div class="card" style="padding:12px">
    <div class="row">
      <div style="flex:1">
        <label>A</label>
        <textarea name="option_a" rows="2" required>{% if item and item.options %}{{ item.options[0].text }}{% endif %}</textarea>
      </div>
      <div style="flex:1">
        <label>B</label>
        <textarea name="option_b" rows="2" required>{% if item and item.options %}{{ item.options[1].text }}{% endif %}</textarea>
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <label>C</label>
        <textarea name="option_c" rows="2" required>{% if item and item.options %}{{ item.options[2].text }}{% endif %}</textarea>
      </div>
      <div style="flex:1">
        <label>D</label>
        <textarea name="option_d" rows="2" required>{% if item and item.options %}{{ item.options[3].text }}{% endif %}</textarea>
      </div>
    </div>

    <label>Correct answer</label>
    {% set ck = (item.correct_key if item else 'A') %}
    <select name="correct_key">
      {% for k in ['A','B','C','D'] %}
        <option value="{{ k }}" {% if ck==k %}selected{% endif %}>{{ k }}</option>
      {% endfor %}
    </select>
  </div>

  <label>Rationale (optional)</label>
  <textarea name="rationale" rows="3">{{ item.rationale if item else '' }}</textarea>

  {% if mode=='edit' %}
    <label>Change note (required)</label>
    <input name="change_note" placeholder="Why are you creating a new version?" required />
  {% else %}
    <label>Change note (optional)</label>
    <input name="change_note" placeholder="Optional note for v1" />
  {% endif %}

  <div class="card" style="margin-top:12px">
    <b>Attached refs</b>
    <div class="muted" style="margin-top:6px">Composite scenario proxy: add multiple tasks/workflows as references.</div>

    <div class="card" style="margin-top:10px;padding:10px">
      <div class="row">
        <div style="width:200px">
          <label>Search type</label>
          <select id="ref-kind">
            <option value="task">task</option>
            <option value="workflow">workflow</option>
          </select>
        </div>
        <div style="flex:1">
          <label>Search title</label>
          <input id="ref-q" placeholder="type to search…" />
        </div>
        <div style="width:160px">
          <label>&nbsp;</label>
          <button class="btn secondary" type="button" id="ref-search">Search</button>
        </div>
        <div style="width:160px">
          <label>&nbsp;</label>
          <button class="btn" type="button" id="ref-peek-primary">Peek anchor</button>
        </div>
      </div>

      <div id="ref-results" class="muted" style="margin-top:10px">Search to add refs.</div>
    </div>

    <table class="table" style="margin-top:10px">
      <thead>
        <tr><th>Type</th><th>Record ID</th><th>Version</th><th></th></tr>
      </thead>
      <tbody id="refs-body">
        {% for r in refs %}
          <tr>
            <td>
              <select name="ref_type">
                <option value="task" {% if r.ref_type=='task' %}selected{% endif %}>task</option>
                <option value="workflow" {% if r.ref_type=='workflow' %}selected{% endif %}>workflow</option>
              </select>
            </td>
            <td><input name="ref_record_id" value="{{ r.ref_record_id }}" /></td>
            <td><input name="ref_version" value="{{ r.ref_version }}" /></td>
            <td style="display:flex;gap:8px">
              {% set comp = 'facts' %}
              {% if (item and item.claim=='concept_probe') %}{% set comp = 'concepts' %}{% endif %}
              {% if (item and item.claim=='procedure_proxy') %}{% set comp = 'procedure' %}{% endif %}
              <a class="btn secondary" target="_blank" rel="noopener noreferrer" href="/_refs/peek?ref_type={{ r.ref_type }}&record_id={{ r.ref_record_id }}&version={{ r.ref_version }}&component={{ comp }}">Peek</a>
              <button class="btn secondary" type="button" onclick="this.closest('tr').remove()">Remove</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div class="muted">Tip: you can also start from <a href="/assessments/new">/assessments/new</a> to prefill the first attachment.</div>
  </div>

  <script>
    (function(){
      const claimEl = document.getElementById('claim');
      const helpersFact = document.getElementById('helpers-fact');
      const helpersConcept = document.getElementById('helpers-concept');
      const helpersScenario = document.getElementById('helpers-scenario');

      function syncHelpers(){
        const c = (claimEl && claimEl.value) || 'auto';
        if(helpersFact) helpersFact.style.display = (c === 'fact_probe') ? 'block' : 'none';
        if(helpersConcept) helpersConcept.style.display = (c === 'concept_probe') ? 'block' : 'none';
        if(helpersScenario) helpersScenario.style.display = (c === 'procedure_proxy') ? 'block' : 'none';
      }
      if(claimEl) claimEl.addEventListener('change', syncHelpers);
      syncHelpers();

      const kindEl = document.getElementById('ref-kind');
      const qEl = document.getElementById('ref-q');
      const btn = document.getElementById('ref-search');
      const peekBtn = document.getElementById('ref-peek-primary');
      const resultsEl = document.getElementById('ref-results');
      const body = document.getElementById('refs-body');

      function esc(s){
        return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":'&#39;'}[c]));
      }

      function addRef(ref){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <select name="ref_type">
              <option value="task" ${ref.ref_type==='task'?'selected':''}>task</option>
              <option value="workflow" ${ref.ref_type==='workflow'?'selected':''}>workflow</option>
            </select>
          </td>
          <td><input name="ref_record_id" value="${esc(ref.record_id)}" /></td>
          <td><input name="ref_version" value="${esc(String(ref.version))}" /></td>
          <td style="display:flex;gap:8px">
            <button class="btn secondary" type="button" data-act="peek">Peek</button>
            <button class="btn secondary" type="button" data-act="remove">Remove</button>
          </td>
        `;
        tr.querySelector('[data-act=remove]').addEventListener('click', () => tr.remove());
        tr.querySelector('[data-act=peek]').addEventListener('click', () => {
          const rt = tr.querySelector('select[name=ref_type]').value;
          const rid = tr.querySelector('input[name=ref_record_id]').value;
          const ver = tr.querySelector('input[name=ref_version]').value;
          const claim = document.querySelector('select[name=claim]')?.value || 'fact_probe';
          let component = 'facts';
          if(claim === 'concept_probe') component = 'concepts';
          if(claim === 'procedure_proxy') component = 'procedure';
          const url = `/_refs/peek?ref_type=${encodeURIComponent(rt)}&record_id=${encodeURIComponent(rid)}&version=${encodeURIComponent(ver)}&component=${encodeURIComponent(component)}`;
          window.open(url, '_blank', 'noopener,noreferrer,width=920,height=720');
        });
        body.appendChild(tr);
      }

      function claimToComponent(){
        const claim = document.querySelector('select[name=claim]')?.value || 'fact_probe';
        if(claim === 'concept_probe') return 'concepts';
        if(claim === 'procedure_proxy') return 'procedure';
        return 'facts';
      }

      function peekAnchor(){
        // use first attached ref row as the anchor
        const first = body && body.querySelector('tr');
        if(!first){
          alert('No refs attached yet. Add a task/workflow ref first.');
          return;
        }
        const rt = first.querySelector('select[name=ref_type]')?.value || 'task';
        const rid = first.querySelector('input[name=ref_record_id]')?.value || '';
        const ver = first.querySelector('input[name=ref_version]')?.value || '';
        if(!rid || !ver){
          alert('Anchor ref is incomplete.');
          return;
        }
        const component = claimToComponent();
        const url = `/_refs/peek?ref_type=${encodeURIComponent(rt)}&record_id=${encodeURIComponent(rid)}&version=${encodeURIComponent(ver)}&component=${encodeURIComponent(component)}`;
        window.open(url, '_blank', 'noopener,noreferrer,width=920,height=720');
      }

      async function search(){
        const kind = kindEl.value;
        const q = qEl.value || '';
        resultsEl.textContent = 'Searching…';
        try{
          const r = await fetch(`/_refs/search?kind=${encodeURIComponent(kind)}&q=${encodeURIComponent(q)}&limit=20`, {headers:{'Accept':'application/json'}});
          if(!r.ok){ resultsEl.textContent = `Search failed (${r.status})`; return; }
          const data = await r.json();
          const items = data.items || [];
          if(!items.length){ resultsEl.textContent = 'No matches.'; return; }
          const lines = items.map(it => {
            const domains = it.domains ? it.domains.join(', ') : (it.domain||'');
            const label = `${it.title} (v${it.version}, ${it.status}${domains?`, ${domains}`:''})`;
            return `<div style="display:flex;gap:10px;align-items:center;margin-top:6px"><button class="btn secondary" type="button" data-rid="${esc(it.record_id)}" data-ver="${esc(String(it.version))}" data-kind="${esc(it.ref_type)}">Add</button><div>${esc(label)}</div></div>`;
          }).join('');
          resultsEl.innerHTML = lines;
          resultsEl.querySelectorAll('button[data-rid]').forEach(b => {
            b.addEventListener('click', () => {
              addRef({ref_type: b.getAttribute('data-kind'), record_id: b.getAttribute('data-rid'), version: b.getAttribute('data-ver')});
            });
          });
        } catch(e){
          resultsEl.textContent = 'Search failed.';
        }
      }

      btn.addEventListener('click', search);
      qEl.addEventListener('keydown', (e) => { if(e.key==='Enter'){ e.preventDefault(); search(); } });
      if(peekBtn) peekBtn.addEventListener('click', peekAnchor);

      // Stem templates
      const stemEl = document.getElementById('stem');
      function insertIfEmpty(t){
        if(!stemEl) return;
        const cur = (stemEl.value || '').trim();
        if(cur){
          if(!confirm('Replace existing stem text with a template?')) return;
        }
        stemEl.value = t;
        try{ stemEl.focus(); }catch(e){}
      }

      const tf = document.getElementById('tpl-fact');
      const tc = document.getElementById('tpl-concept');
      const ts = document.getElementById('tpl-scenario');
      if(tf) tf.addEventListener('click', () => insertIfEmpty('What is the ____?'));
      if(tc) tc.addEventListener('click', () => insertIfEmpty('Why does ____?'));
      if(ts) ts.addEventListener('click', () => insertIfEmpty('Given the following scenario, why does ____?\n\nScenario:\n____'));

      // Peek source: open first workflow ref if present, otherwise first ref.
      const peekSourceBtn = document.getElementById('peek-source');
      function peekSource(){
        const rows = body ? Array.from(body.querySelectorAll('tr')) : [];
        if(!rows.length){ alert('No refs attached yet. Add a workflow ref first.'); return; }
        // prefer workflow
        let row = rows.find(r => (r.querySelector('select[name=ref_type]')?.value === 'workflow')) || rows[0];
        const rt = row.querySelector('select[name=ref_type]')?.value || 'workflow';
        const rid = row.querySelector('input[name=ref_record_id]')?.value || '';
        const ver = row.querySelector('input[name=ref_version]')?.value || '';
        if(!rid || !ver){ alert('Ref is incomplete.'); return; }
        const claim = (claimEl && claimEl.value) || 'auto';
        let component = 'facts';
        if(claim === 'concept_probe') component = 'concepts';
        if(claim === 'procedure_proxy') component = 'procedure';
        const url = `/_refs/peek?ref_type=${encodeURIComponent(rt)}&record_id=${encodeURIComponent(rid)}&version=${encodeURIComponent(ver)}&component=${encodeURIComponent(component)}`;
        window.open(url, '_blank', 'noopener,noreferrer,width=980,height=760');
      }
      if(peekSourceBtn) peekSourceBtn.addEventListener('click', peekSource);
    })();
  </script>

  <div class="row" style="margin-top:14px">
    <button class="btn" type="submit">Save (new version)</button>
    {% if mode=='edit' %}
      <a class="btn secondary" href="/assessments/{{ item.record_id }}/{{ item.version }}">Cancel</a>
    {% else %}
      <a class="btn secondary" href="/assessments">Back</a>
    {% endif %}
  </div>
</form>

{% endblock %}
