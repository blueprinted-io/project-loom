<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or "LCS MVP" }}</title>
  <link rel="stylesheet" href="/static/style.css?v=46" />
</head>
<body class="spa-v1">
  <header class="topbar">
    <div class="wrap">
      <div class="brand">
        <a class="brand-link" href="/">
          <span class="brand-name">blueprinted.io</span>
        </a>
      </div>
      <div class="topbar-right">
        <div class="userchip">
          <div>
            <span class="userchip-label">User</span>
            <b><a href="/profile" style="color:inherit; text-decoration:none">{{ request.state.user }}</a></b>
            <span class="muted">·</span>
            <span class="role">{{ request.state.role }}</span>
          </div>
        </div>
        <button class="btn secondary" type="button" id="theme-toggle" title="Theme">Theme</button>
        <form method="post" action="/logout" style="display:inline">
          <button class="btn secondary" type="submit">Logout</button>
        </form>
      </div>
    </div>

    <div class="pulse" id="pulse" aria-live="polite">
      <div class="wrap pulse-inner">
        <div class="pulse-left">
          <span class="pulse-title">Governance pulse</span>
          <span class="pulse-item" id="pulse-workflows">Workflows: …</span>
          <span class="pulse-item" id="pulse-tasks">Tasks: …</span>
          <span class="pulse-item" id="pulse-assessments">Assessments: …</span>
          <span class="pulse-item" id="pulse-review" style="display:none">Review: …</span>
        </div>
        <div class="pulse-right">
          <span class="pulse-item muted" id="pulse-audit">Last audit: …</span>
        </div>
      </div>
    </div>
  </header>

  <script>
    (function(){
      function setTheme(mode){
        const root = document.documentElement;
        // Default is light. Only set attribute for dark.
        if(mode === 'dark'){
          root.setAttribute('data-theme', 'dark');
          try{ localStorage.setItem('theme', 'dark'); }catch(e){}
        } else {
          root.removeAttribute('data-theme');
          try{ localStorage.setItem('theme', 'light'); }catch(e){}
        }
        const btn = document.getElementById('theme-toggle');
        if(btn){
          const cur = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          btn.textContent = `Theme: ${cur}`;
        }
      }

      function initTheme(){
        const btn = document.getElementById('theme-toggle');
        let saved = 'light';
        try{ saved = localStorage.getItem('theme') || 'light'; }catch(e){}

        setTheme(saved === 'dark' ? 'dark' : 'light');

        if(btn){
          btn.addEventListener('click', function(){
            const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
            const next = (cur === 'light') ? 'dark' : 'light';
            setTheme(next);
          });
        }
      }

      async function loadPulse(){
        try{
          const r = await fetch('/_pulse', {headers: {'Accept':'application/json'}});
          if(!r.ok) return;
          const data = await r.json();

          const t = data.tasks || {};
          const w = data.workflows || {};
          const asmt = data.assessments || {};

          const tasksEl = document.getElementById('pulse-tasks');
          if(tasksEl) tasksEl.textContent = `Tasks: ${t.draft||0} draft · ${t.submitted||0} submitted · ${t.confirmed||0} confirmed`;

          const wfEl = document.getElementById('pulse-workflows');
          if(wfEl) wfEl.textContent = `Workflows: ${w.draft||0} draft · ${w.submitted||0} submitted · ${w.confirmed||0} confirmed`;

          const asEl = document.getElementById('pulse-assessments');
          if(asEl) asEl.textContent = `Assessments: ${asmt.draft||0} draft · ${asmt.submitted||0} submitted · ${asmt.confirmed||0} confirmed`;

          const rev = (data.review||{});
          const revEl = document.getElementById('pulse-review');
          if(revEl && rev.pending !== null && rev.pending !== undefined){
            revEl.style.display = 'inline-flex';
            revEl.textContent = `Review: ${rev.pending} pending`;
          }

          const lastAudit = (data.audit||{}).last;
          const auditEl = document.getElementById('pulse-audit');
          if(auditEl){
            if(lastAudit && lastAudit.at){
              auditEl.textContent = `Last audit: ${lastAudit.action} by ${lastAudit.actor} at ${lastAudit.at}`;
            } else {
              auditEl.textContent = 'Last audit: none';
            }
          }
        } catch(e) {
          // no-op
        }
      }

      function initRail(){
        const body = document.body;
        const railToggle = document.getElementById('rail-toggle');
        const railToggleMobile = document.getElementById('rail-toggle-mobile');
        const railCloseMobile = document.getElementById('rail-close-mobile');
        const railBackdrop = document.getElementById('rail-backdrop');

        function isMobile(){
          return window.matchMedia('(max-width: 980px)').matches;
        }

        function applyRail(state){
          body.classList.toggle('rail-collapsed', state === 'collapsed');
          if(railToggle){
            railToggle.textContent = state === 'collapsed' ? '»' : '«';
            railToggle.setAttribute('aria-label', state === 'collapsed' ? 'Expand navigation rail' : 'Collapse navigation rail');
            railToggle.setAttribute('title', state === 'collapsed' ? 'Expand navigation rail' : 'Collapse navigation rail');
          }
          try{ localStorage.setItem('rail', state); }catch(e){}
        }

        let saved = 'expanded';
        try{ saved = localStorage.getItem('rail') || 'expanded'; }catch(e){}
        applyRail(saved === 'collapsed' ? 'collapsed' : 'expanded');
        body.classList.remove('mobile-rail-open');

        const icons = {
          'Dashboard':'⌂',
          'Workflows':'▦',
          'Tasks':'✓',
          'Review queue':'⧉',
          'Content output':'⇢',
          'Assessments':'◈',
          'Audit Log':'◷',
          'Exports library':'⬒',
          'Import PDF':'⇪',
          'Import JSON':'⇪',
          'Users':'◉',
          'Domains':'◌',
          'Switch database':'⌁',
          'Explainer':'?'
        };

        const railAvatar = document.getElementById('rail-avatar');
        const railAvatarFallback = document.getElementById('rail-avatar-fallback');
        if(railAvatar){
          railAvatar.addEventListener('error', function(){
            railAvatar.style.display = 'none';
            if(railAvatarFallback) railAvatarFallback.style.display = 'flex';
          });
          railAvatar.addEventListener('load', function(){
            railAvatar.style.display = 'block';
            if(railAvatarFallback) railAvatarFallback.style.display = 'none';
          });
        }

        document.querySelectorAll('.navlink').forEach(function(link){
          if(link.querySelector('.navtext')) return;
          const text = (link.textContent || '').trim();
          const icon = document.createElement('span');
          icon.className = 'navicon';
          icon.setAttribute('aria-hidden', 'true');
          icon.textContent = icons[text] || '•';

          const label = document.createElement('span');
          label.className = 'navtext';
          label.textContent = text;

          link.textContent = '';
          link.appendChild(icon);
          link.appendChild(label);
          link.setAttribute('title', text);
        });

        function toggleMobileRail(open){
          body.classList.toggle('mobile-rail-open', open);
        }

        function toggleRailDesktop(){
          const cur = body.classList.contains('rail-collapsed') ? 'collapsed' : 'expanded';
          applyRail(cur === 'expanded' ? 'collapsed' : 'expanded');
        }

        if(railToggle) railToggle.addEventListener('click', function(){
          if(isMobile()) return;
          toggleRailDesktop();
        });
        if(railToggleMobile) railToggleMobile.addEventListener('click', function(){ toggleMobileRail(true); });
        if(railCloseMobile) railCloseMobile.addEventListener('click', function(){ toggleMobileRail(false); });
        if(railBackdrop) railBackdrop.addEventListener('click', function(){ toggleMobileRail(false); });

        document.querySelectorAll('.navlink').forEach(function(link){
          link.addEventListener('click', function(){ if(isMobile()) toggleMobileRail(false); });
        });

        window.addEventListener('resize', function(){
          if(!isMobile()) body.classList.remove('mobile-rail-open');
        });
      }

      function boot(){
        initTheme();
        initRail();
        loadPulse();
      }

      if(document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', boot);
      } else {
        boot();
      }
    })();
  </script>

  <div class="layout spa-layout">
    <aside class="sidebar" id="app-rail">
      <div class="sidebar-shell-controls">
        <button class="btn secondary rail-toggle" type="button" id="rail-toggle" aria-label="Collapse navigation rail" title="Collapse navigation rail">«</button>
        <button class="btn secondary rail-close-mobile" type="button" id="rail-close-mobile" aria-label="Close navigation" title="Close navigation">✕</button>
      </div>

      <section class="rail-profile" aria-label="Current user">
        <div class="rail-profile-main">
          <a class="rail-avatar-wrap" href="/profile" title="Open profile">
            <img src="/profile/avatar" alt="avatar" class="rail-avatar" id="rail-avatar" />
            <span class="rail-avatar-fallback" id="rail-avatar-fallback">{{ (request.state.user or '?')[:1]|upper }}</span>
          </a>
          <a class="rail-profile-text" href="/profile" title="Open profile">
            <span class="rail-profile-label">Signed in</span>
            <span class="rail-profile-user">{{ request.state.user }}</span>
            <span class="rail-profile-role">{{ request.state.role }}</span>
          </a>
          <form method="post" action="/logout" class="rail-logout-inline-form">
            <button class="btn secondary rail-logout-inline" type="submit" aria-label="Logout" title="Logout">⎋</button>
          </form>
        </div>
      </section>

      {% set role = request.state.role %}

      <div class="sidebar-section">
        <a class="navlink {% if request.url.path == '/' %}active{% endif %}" href="/">Dashboard</a>
      </div>

      {% if role == 'admin' %}
        <div class="sidebar-section">
          <div class="sidebar-title">Records</div>
          <a class="navlink {% if request.url.path.startswith('/workflows') %}active{% endif %}" href="/workflows">Workflows</a>
          <a class="navlink {% if request.url.path.startswith('/tasks') %}active{% endif %}" href="/tasks">Tasks</a>
          <a class="navlink {% if request.url.path.startswith('/review') %}active{% endif %}" href="/review">Review queue</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Delivery <span class="sidebar-flag">not yet functional</span></div>
          <a class="navlink {% if request.url.path.startswith('/delivery') %}active{% endif %}" href="/delivery">Content output</a>
          <a class="navlink {% if request.url.path.startswith('/assessments') %}active{% endif %}" href="/assessments">Assessments</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Assurance</div>
          <a class="navlink {% if request.url.path.startswith('/audit') %}active{% endif %}" href="/audit">Audit Log</a>
          <a class="navlink {% if request.url.path.startswith('/exports') %}active{% endif %}" href="/exports">Exports library</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Ingestion <span class="sidebar-flag">not yet functional</span></div>
          <a class="navlink {% if request.url.path.startswith('/import/pdf') %}active{% endif %}" href="/import/pdf">Import PDF</a>
          <a class="navlink {% if request.url.path.startswith('/import/json') %}active{% endif %}" href="/import/json">Import JSON</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Admin</div>
          <a class="navlink {% if request.url.path.startswith('/admin/users') %}active{% endif %}" href="/admin/users">Users</a>
          <a class="navlink {% if request.url.path.startswith('/admin/domains') %}active{% endif %}" href="/admin/domains">Domains</a>
          <a class="navlink {% if request.url.path.startswith('/db') %}active{% endif %}" href="/db">Switch database</a>
        </div>

      {% elif role == 'author' %}
        {% if can(role, 'import:pdf') or can(role, 'import:json') %}
        <div class="sidebar-section">
          <div class="sidebar-title">Ingestion <span class="sidebar-flag">not yet functional</span></div>
          {% if can(role, 'import:pdf') %}
            <a class="navlink {% if request.url.path.startswith('/import/pdf') %}active{% endif %}" href="/import/pdf">Import PDF</a>
          {% endif %}
          {% if can(role, 'import:json') %}
            <a class="navlink {% if request.url.path.startswith('/import/json') %}active{% endif %}" href="/import/json">Import JSON</a>
          {% endif %}
        </div>
        {% endif %}

        <div class="sidebar-section">
          <div class="sidebar-title">Records</div>
          <a class="navlink {% if request.url.path.startswith('/workflows') %}active{% endif %}" href="/workflows">Workflows</a>
          <a class="navlink {% if request.url.path.startswith('/tasks') %}active{% endif %}" href="/tasks">Tasks</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Delivery <span class="sidebar-flag">not yet functional</span></div>
          <a class="navlink {% if request.url.path.startswith('/delivery') %}active{% endif %}" href="/delivery">Content output</a>
          <a class="navlink {% if request.url.path.startswith('/assessments') %}active{% endif %}" href="/assessments">Assessments</a>
        </div>

      {% elif role == 'audit' %}
        {% if can(role, 'audit:view') or can(role, 'export:library') %}
        <div class="sidebar-section">
          <div class="sidebar-title">Assurance</div>
          {% if can(role, 'audit:view') %}
            <a class="navlink {% if request.url.path.startswith('/audit') %}active{% endif %}" href="/audit">Audit Log</a>
          {% endif %}
          {% if can(role, 'export:library') %}
            <a class="navlink {% if request.url.path.startswith('/exports') %}active{% endif %}" href="/exports">Exports library</a>
          {% endif %}
        </div>
        {% endif %}

        <div class="sidebar-section">
          <div class="sidebar-title">Records</div>
          <a class="navlink {% if request.url.path.startswith('/workflows') %}active{% endif %}" href="/workflows">Workflows</a>
          <a class="navlink {% if request.url.path.startswith('/tasks') %}active{% endif %}" href="/tasks">Tasks</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Delivery <span class="sidebar-flag">not yet functional</span></div>
          <a class="navlink {% if request.url.path.startswith('/delivery') %}active{% endif %}" href="/delivery">Content output</a>
          <a class="navlink {% if request.url.path.startswith('/assessments') %}active{% endif %}" href="/assessments">Assessments</a>
        </div>

      {% elif role == 'content_publisher' %}
        <div class="sidebar-section">
          <div class="sidebar-title">Delivery <span class="sidebar-flag">not yet functional</span></div>
          <a class="navlink {% if request.url.path.startswith('/delivery') %}active{% endif %}" href="/delivery">Content output</a>
          <a class="navlink {% if request.url.path.startswith('/assessments') %}active{% endif %}" href="/assessments">Assessments</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Records</div>
          <a class="navlink {% if request.url.path.startswith('/workflows') %}active{% endif %}" href="/workflows">Workflows</a>
          <a class="navlink {% if request.url.path.startswith('/tasks') %}active{% endif %}" href="/tasks">Tasks</a>
        </div>

      {% else %}
        <div class="sidebar-section">
          <div class="sidebar-title">Delivery <span class="sidebar-flag">not yet functional</span></div>
          <a class="navlink {% if request.url.path.startswith('/delivery') %}active{% endif %}" href="/delivery">Content output</a>
          <a class="navlink {% if request.url.path.startswith('/assessments') %}active{% endif %}" href="/assessments">Assessments</a>
        </div>

        <div class="sidebar-section">
          <div class="sidebar-title">Records</div>
          <a class="navlink {% if request.url.path.startswith('/workflows') %}active{% endif %}" href="/workflows">Workflows</a>
          <a class="navlink {% if request.url.path.startswith('/tasks') %}active{% endif %}" href="/tasks">Tasks</a>
          {% if role in ['reviewer'] %}
            <a class="navlink {% if request.url.path.startswith('/review') %}active{% endif %}" href="/review">Review queue</a>
          {% endif %}
        </div>
      {% endif %}

      <div class="sidebar-section">
        <div class="sidebar-title">Help</div>
        <a class="navlink {% if request.url.path.startswith('/explainer') %}active{% endif %}" href="/explainer">Explainer</a>
      </div>

      <div class="sidebar-foot muted">
        Active DB: <b>{{ request.state.db_key }}</b>
      </div>
    </aside>
    <div class="rail-backdrop" id="rail-backdrop" aria-hidden="true"></div>

    <main class="content wrap spa-main">
      <button class="btn secondary rail-toggle-mobile" type="button" id="rail-toggle-mobile" aria-label="Open navigation" title="Open navigation">☰ Menu</button>
      <form class="spa-shell-search card" role="search" aria-label="Application search" method="get" action="/search">
        <input type="text" id="spa-search" name="q" placeholder="Search tasks, workflows, domains, tags..." autocomplete="off" />
      </form>
      <div class="global-dev-banner" role="status" aria-live="polite">
        <strong>Active development notice:</strong>
        This application is an MVP in active development. Features, UI, and behavior may change without notice. It is not designed for operational use at this stage.
      </div>
      {% block content %}{% endblock %}
    </main>
  </div>
</body>
</html>
