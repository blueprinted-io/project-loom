<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ title or "LCS MVP" }}</title>
  <link rel="stylesheet" href="/static/style.css?v=2" />
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <div class="brand">
        <a class="brand-link" href="/">
          <img class="brand-logo" src="/static/blueprinted.png" alt="blueprinted.io" />
          <span class="brand-name">blueprinted.io</span>
        </a>
      </div>
      <div class="topbar-right">
        <button class="btn secondary mobile-only" type="button" id="nav-toggle" title="Menu">Menu</button>
        <div class="userchip">
          <div class="userchip-label">User</div>
          <div><b>{{ request.state.user }}</b> <span class="muted">·</span> <span class="role">{{ request.state.role }}</span></div>
        </div>
        <button class="btn secondary" type="button" id="theme-toggle" title="Theme">Theme</button>
        <form method="post" action="/logout" style="display:inline">
          <button class="btn secondary" type="submit">Logout</button>
        </form>
      </div>
    </div>

    <div class="pulse" id="pulse" aria-live="polite">
      <div class="wrap pulse-inner">
        <div class="pulse-left">
          <span class="pulse-title">Governance pulse</span>
          <span class="pulse-item" id="pulse-tasks">Tasks: …</span>
          <span class="pulse-item" id="pulse-workflows">Workflows: …</span>
          <span class="pulse-item" id="pulse-review" style="display:none">Review: …</span>
        </div>
        <div class="pulse-right">
          <span class="pulse-item muted" id="pulse-audit">Last audit: …</span>
        </div>
      </div>
    </div>
  </header>

  <script>
    (function(){
      function setTheme(mode){
        const root = document.documentElement;
        if(mode === 'light' || mode === 'dark'){
          root.setAttribute('data-theme', mode);
          try{ localStorage.setItem('theme', mode); }catch(e){}
        } else {
          root.removeAttribute('data-theme');
          try{ localStorage.removeItem('theme'); }catch(e){}
        }
        const btn = document.getElementById('theme-toggle');
        if(btn){
          const cur = root.getAttribute('data-theme') || 'auto';
          btn.textContent = `Theme: ${cur}`;
        }
      }

      function initTheme(){
        const btn = document.getElementById('theme-toggle');
        let saved = null;
        try{ saved = localStorage.getItem('theme'); }catch(e){}

        // Apply saved selection (or auto)
        if(saved === 'light' || saved === 'dark') setTheme(saved);
        else setTheme('auto');

        if(btn){
          btn.addEventListener('click', function(){
            const cur = document.documentElement.getAttribute('data-theme') || 'auto';
            const next = (cur === 'auto') ? 'light' : (cur === 'light' ? 'dark' : 'auto');
            setTheme(next);

            // Ensure label updates even if CSS changes are subtle.
            const cur2 = document.documentElement.getAttribute('data-theme') || 'auto';
            btn.textContent = `Theme: ${cur2}`;
          });
        }
      }

      async function loadPulse(){
        try{
          const r = await fetch('/_pulse', {headers: {'Accept':'application/json'}});
          if(!r.ok) return;
          const data = await r.json();

          const t = data.tasks || {};
          const w = data.workflows || {};

          const tasksEl = document.getElementById('pulse-tasks');
          if(tasksEl) tasksEl.textContent = `Tasks: ${t.draft||0} draft · ${t.submitted||0} submitted · ${t.confirmed||0} confirmed`;

          const wfEl = document.getElementById('pulse-workflows');
          if(wfEl) wfEl.textContent = `Workflows: ${w.draft||0} draft · ${w.submitted||0} submitted · ${w.confirmed||0} confirmed`;

          const rev = (data.review||{});
          const revEl = document.getElementById('pulse-review');
          if(revEl && rev.pending !== null && rev.pending !== undefined){
            revEl.style.display = 'inline-flex';
            revEl.textContent = `Review: ${rev.pending} pending`;
          }

          const a = (data.audit||{}).last;
          const auditEl = document.getElementById('pulse-audit');
          if(auditEl){
            if(a && a.at){
              auditEl.textContent = `Last audit: ${a.action} by ${a.actor} at ${a.at}`;
            } else {
              auditEl.textContent = 'Last audit: none';
            }
          }
        } catch(e) {
          // no-op
        }
      }

      function setSidebarOpen(open){
        const sb = document.getElementById('sidebar');
        const bd = document.getElementById('sidebar-backdrop');
        if(!sb || !bd) return;
        if(open){
          sb.classList.add('open');
          bd.classList.add('show');
          try{ document.body.classList.add('no-scroll'); }catch(e){}
        } else {
          sb.classList.remove('open');
          bd.classList.remove('show');
          try{ document.body.classList.remove('no-scroll'); }catch(e){}
        }
      }

      function initMobileNav(){
        const btn = document.getElementById('nav-toggle');
        const bd = document.getElementById('sidebar-backdrop');
        if(btn){
          btn.addEventListener('click', function(){
            const sb = document.getElementById('sidebar');
            const open = sb && sb.classList.contains('open');
            setSidebarOpen(!open);
          });
        }
        if(bd){
          bd.addEventListener('click', function(){ setSidebarOpen(false); });
        }
      }

      initTheme();
      initMobileNav();
      loadPulse();
    })();
  </script>

  <div class="layout wrap">
    <div class="sidebar-backdrop" id="sidebar-backdrop"></div>
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Records</div>
        <a class="navlink" href="/tasks">Tasks</a>
        <a class="navlink" href="/workflows">Workflows</a>
        {% if request.state.role in ['reviewer','admin'] %}
          <a class="navlink" href="/review">Review queue</a>
        {% endif %}
      </div>

      {% if can(request.state.role, 'audit:view') %}
      <div class="sidebar-section">
        <div class="sidebar-title">Assurance</div>
        <a class="navlink" href="/audit">Audit Log</a>
      </div>
      {% endif %}

      {% if can(request.state.role, 'import:pdf') or can(request.state.role, 'import:json') %}
      <div class="sidebar-section">
        <div class="sidebar-title">Ingestion</div>
        {% if can(request.state.role, 'import:pdf') %}
          <a class="navlink" href="/import/pdf">Import PDF</a>
        {% endif %}
        {% if can(request.state.role, 'import:json') %}
          <a class="navlink" href="/import/json">Import JSON</a>
        {% endif %}
      </div>
      {% endif %}

      {% if request.state.role == 'admin' %}
      <div class="sidebar-section">
        <div class="sidebar-title">Admin</div>
        <a class="navlink" href="/admin/users">Users</a>
        <a class="navlink" href="/admin/domains">Domains</a>
        <a class="navlink" href="/db">Switch database</a>
      </div>
      {% endif %}

      <div class="sidebar-section">
        <div class="sidebar-title">Help</div>
        <a class="navlink" href="/explainer">Explainer</a>
      </div>

      <div class="sidebar-foot muted">
        Active DB: <b>{{ request.state.db_key }}</b>
      </div>
    </aside>

    <main class="content">
      {% block content %}{% endblock %}
    </main>
  </div>
</body>
</html>
