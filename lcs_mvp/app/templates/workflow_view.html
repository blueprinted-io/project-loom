{% extends "base.html" %}
{% block content %}
<div class="row">
  <div>
    <h1>Workflow</h1>
    <div class="muted">Version <code>{{ workflow.version }}</code></div>
  </div>
  <div class="row-right">
    <span class="badge badge-{{ workflow.status }}">{{ workflow.status }}</span>

    {% if readiness == 'ready' %}
      <span class="badge badge-confirmed">ready</span>
    {% elif readiness == 'awaiting_task_confirmation' %}
      <span class="badge badge-warn">awaiting_task_confirmation</span>
    {% else %}
      <span class="badge badge-deprecated">invalid</span>
    {% endif %}

    <a class="btn" href="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/export.md">Export Markdown</a>

    {% if workflow.status == 'confirmed' and readiness == 'ready' %}
      <a class="btn" href="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/export.docx">Export DOCX</a>
    {% else %}
      <span class="muted">DOCX export requires confirmed workflow + confirmed tasks.</span>
    {% endif %}

    {% if can(request.state.role, 'assessment:create') %}
      <a class="btn secondary" href="/assessments/new?ref_type=workflow&ref_record_id={{ workflow.record_id }}&ref_version={{ workflow.version }}">New assessment</a>
    {% endif %}

    {% if can(request.state.role, 'workflow:revise') %}
      <a class="btn" href="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/revise">Revise</a>
    {% endif %}
  </div>
</div>

<div class="card">
  <h2>{{ workflow.title }}</h2>
  <p><b>Objective:</b> {{ workflow.objective }}</p>

  {% if domains %}
    <p class="muted">Domains (derived): {% for d in domains %}<span class="badge">{{ d }}</span> {% endfor %}</p>
  {% endif %}

  {% if readiness != 'ready' %}
    <div class="callout warn">
      <b>Not ready to confirm</b>
      {% if readiness_reasons %}
        <ul>
          {% for r in readiness_reasons %}<li>{{ r }}</li>{% endfor %}
        </ul>
      {% endif %}
      {% if blocking_task_refs %}
        <div class="muted">Blocking task versions:</div>
        <ul>
          {% for rid, ver, st in blocking_task_refs %}
            <li><a href="/tasks/{{ rid }}/{{ ver }}">{{ rid }}@{{ ver }}</a> — <span class="badge badge-warn">{{ st }}</span></li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">No blocking Task versions detected.</div>
      {% endif %}
    </div>
  {% endif %}

  <!-- record metadata shown in admin-only section below -->

  <h3>Tasks</h3>
  <ol>
    {% for r in refs %}
      <li>
        <a href="/tasks/{{ r.record_id }}/{{ r.version }}">{{ r.title }}</a>
        <span class="muted">({{ r.record_id }}@{{ r.version }})</span>
        {% if r.task_status != 'confirmed' %}
          <span class="badge badge-warn">{{ r.task_status }}</span>
        {% endif %}
      </li>
    {% endfor %}
  </ol>

  {% if request.state.role == 'admin' %}
    <details class="card" style="margin-top:14px">
      <summary><b>Record metadata</b> <span class="muted">(admin only)</span></summary>
      <div style="margin-top:10px">
        <p class="muted">record_id=<code>{{ workflow.record_id }}</code> · version=<code>{{ workflow.version }}</code></p>
        <p class="muted">created_by={{ workflow.created_by }} · created_at={{ workflow.created_at }}</p>
        <p class="muted">updated_by={{ workflow.updated_by }} · updated_at={{ workflow.updated_at }}</p>
        {% if workflow.reviewed_by %}
          <p class="muted">reviewed_by={{ workflow.reviewed_by }} · reviewed_at={{ workflow.reviewed_at }}</p>
        {% endif %}
        {% if workflow.change_note %}
          <p class="muted">change_note={{ workflow.change_note }}</p>
        {% endif %}
      </div>
    </details>
  {% endif %}
</div>

<div class="row">
  {% if workflow.status == 'draft' and can(request.state.role, 'workflow:submit') %}
  <form method="post" action="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/submit">
    <button class="btn" type="submit">Submit for review</button>
  </form>
  {% endif %}

  {% if workflow.status == 'submitted' and can(request.state.role, 'workflow:confirm') %}
  <form method="post" action="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/confirm">
    <button class="btn" type="submit">Confirm (reviewer)</button>
  </form>
  {% endif %}

  {% if request.state.role == 'admin' %}
    <form method="post" action="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/force-submit">
      <button class="btn secondary" type="submit">Force submit</button>
    </form>
    <form method="post" action="/workflows/{{ workflow.record_id }}/{{ workflow.version }}/force-confirm">
      <button class="btn secondary" type="submit">Force confirm</button>
    </form>
  {% endif %}
</div>

{% endblock %}
