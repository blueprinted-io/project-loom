{% extends "base.html" %}
{% block content %}
<div class="row">
  <div>
    <h1>Task</h1>
    <div class="muted">Version <code>{{ task.version }}</code></div>
  </div>
  <div class="row-right">
    <span class="badge badge-{{ task.status }}">{{ task.status }}</span>

    {% if can(request.state.role, 'task:revise') %}
      <form method="post" action="/tasks/{{ task.record_id }}/{{ task.version }}/new-version">
        <button class="btn" type="submit">New version</button>
      </form>
      <a class="btn" href="/tasks/{{ task.record_id }}/{{ task.version }}/edit">Revise</a>
    {% endif %}
  </div>
</div>

{% if warnings %}
  <div class="callout warn">
    <b>Lint warnings (warnings-only):</b>
    <ul>
      {% for w in warnings %}<li>{{ w }}</li>{% endfor %}
    </ul>
  </div>
{% endif %}

<div class="card">
  <h2>{{ task.title }}</h2>
  <p><b>Outcome:</b> {{ task.outcome }}</p>
  <p><b>Procedure name:</b> {{ task.procedure_name }}</p>
  <p><b>Irreversible:</b> {{ 'yes' if task.irreversible_flag else 'no' }}</p>

  <h3>Facts</h3>
  <ul>
    {% for f in task.facts %}<li>{{ f }}</li>{% endfor %}
  </ul>

  <h3>Concepts</h3>
  <ul>
    {% for c in task.concepts %}<li>{{ c }}</li>{% endfor %}
  </ul>

  <h3>Dependencies</h3>
  <ul>
    {% for d in task.dependencies %}<li>{{ d }}</li>{% endfor %}
  </ul>

  <h3>Steps</h3>
  <ol>
    {% for st in task.steps %}
      <li>
        <div>{{ st.text }}</div>
        {% if st.completion %}
          <div class="muted">Completion: {{ st.completion }}</div>
        {% endif %}
      </li>
    {% endfor %}
  </ol>
  {% if request.state.role == 'admin' %}
    <details class="card" style="margin-top:14px">
      <summary><b>Record metadata</b> <span class="muted">(admin only)</span></summary>
      <div style="margin-top:10px">
        <p class="muted">record_id=<code>{{ task.record_id }}</code> 路 version=<code>{{ task.version }}</code></p>
        <p class="muted">created_by={{ task.created_by }} 路 created_at={{ task.created_at }}</p>
        <p class="muted">updated_by={{ task.updated_by }} 路 updated_at={{ task.updated_at }}</p>
        {% if task.reviewed_by %}
          <p class="muted">reviewed_by={{ task.reviewed_by }} 路 reviewed_at={{ task.reviewed_at }}</p>
        {% endif %}
        {% if task.change_note %}
          <p class="muted">change_note={{ task.change_note }}</p>
        {% endif %}
      </div>
    </details>
  {% endif %}
</div>

<div class="row">
  {% if task.status == 'draft' and can(request.state.role, 'task:submit') %}
  <form method="post" action="/tasks/{{ task.record_id }}/{{ task.version }}/submit">
    <button class="btn" type="submit">Submit for review</button>
  </form>
  {% endif %}

  {% if task.status == 'submitted' and can(request.state.role, 'task:confirm') %}
  <form method="post" action="/tasks/{{ task.record_id }}/{{ task.version }}/confirm">
    <button class="btn" type="submit">Confirm (reviewer)</button>
  </form>
  {% endif %}
</div>

{% endblock %}
